<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>CentOS 7 安装Python 3</title>
    <url>/2019/03/14/centos-install-python3/</url>
    <content><![CDATA[<h2 id="CentOS-7-安装Python3"><a href="#CentOS-7-安装Python3" class="headerlink" title="CentOS 7 安装Python3"></a>CentOS 7 安装Python3</h2><blockquote>
<p>CentOS 7 默认值安装有Python 2.x 解释器，并不含有Python 3的解释器，需要单独安装</p>
</blockquote>
<a id="more"></a>

<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sudo yum update</span><br><span class="line">sudo yum install yum-utils</span><br><span class="line">sudo yum groupinstall development</span><br><span class="line">sudo yum install https://centos7.iuscommunity.org/ius-release.rpm</span><br><span class="line">sudo yum install python36u</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
        <category>CentOS</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>CentOS 7网络配置</title>
    <url>/2019/03/14/centos-network-configuration/</url>
    <content><![CDATA[<h2 id="CentOS-7-网络配置"><a href="#CentOS-7-网络配置" class="headerlink" title="CentOS 7 网络配置"></a>CentOS 7 网络配置</h2><blockquote>
<p>问题描述：以最小模式安装好CentOS 7后，发现无法连接网络，ifconfig命令也无法使用</p>
</blockquote>
<a id="more"></a>

<ol>
<li><p>先检查<code>ifconfig</code>命令无法使用的原因<br>使用<code>echo $PATH</code>命令，检查<code>$PATH</code>是否配置正确，结果显示如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ehco $PATH</span><br><span class="line">/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/root/bin</span><br></pre></td></tr></table></figure>

<p>从返回的结果来看，系统的bin目录已经包含在内，可以推测出，CentOS的最小安装模式默认没有<code>ifconfig</code>命令。因此，我们需要先想办法将虚拟机连接至网络，再通过yum源来安装ifconfig命令</p>
</li>
<li><p>设置虚拟机网络连接<br>使用<code>ip addr</code>命令，查看网卡当前设置，结果如下：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever prefered_lft forever</span><br><span class="line">    inet6 ::1/128 scope host</span><br><span class="line">       valid_lft forever prefered_lft forever</span><br><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:0f:d6:f6 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>

<p>在这里，可以看到enp0s3这块网卡，应该就是虚拟机的网卡，但是这块网卡当前并未分配IP地址。既然没有ip地址，那直接去<code>/etc/sysconfig/network-scripts</code>目录中看一下的网卡ip信息的配置文件名吧。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ls /etc/sysconfig/network-scripts</span><br><span class="line">ifcfg-enp0s3     ifdown-ppp          ifup-eth        ifup-sit</span><br><span class="line">ifcfg-lo         ifdown-routes       ifup-ippp       ifup-Team</span><br><span class="line">ifdown           ifdown-sit          ifup-ipv6       ifup-TeamPort</span><br><span class="line">ifdown-dnep      ifdown-Team         ifup-isdn       ifup-tunnel</span><br><span class="line">ifdown-eth       ifdown-TeamPort     ifup-plip       ifup-wireless</span><br><span class="line">ifdown-ippp      ifdown-tunnel       ifup-plusb      init.ipv6-global</span><br><span class="line">ifdown-ipv6      ifup                ifup-post       network-functions</span><br><span class="line">ifdown-isdn      ifup-aliases        ifup-ppp        network-functions-ipv6</span><br><span class="line">ifdown-post      ifup-bnep           ifup-routes</span><br></pre></td></tr></table></figure>

<p>从显示的结果来看，网卡的配置文件应当为<code>ifcfg-enp0s3</code>，查看该文件内容：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@centos1 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp2s0</span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=dhcp</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=enp0s3</span><br><span class="line">UUID=13cbc11b-fdc9-4663-ab1a-fbc3e279c85c</span><br><span class="line">ONBOOT=no</span><br></pre></td></tr></table></figure>

<p>可以看到，<code>BOOTPROTO=dhcp</code>已经将IP地址的获取设置为dhcp模式，但是<code>ONBOOT=no</code>将网卡随开机启动设置为关闭状态，所以我们要将其设置为<code>ONBOOT=yes</code>。设置完成后，可以使用<code>ifup enp0s3</code>命令，启动网卡，也可以用<code>shutdown -r</code>命令，重启系统。重启系统之后，再用<code>ip addr</code>命令查看其网卡设置：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: enp0s3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 08:00:27:0f:d6:f6 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 10.0.2.15/24 brd 10.0.2.255 scope global noprefixroute dynamic enp0s3</span><br><span class="line">       valid_lft 86257sec preferred_lft 86257sec</span><br><span class="line">    inet6 fe80::facf:7da3:d61b:6a39/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>

<p>因为以最小模式安装CentOS 7，就已经默认安装并启动了ssh，因此就可以通过ssh连接虚拟机，愉快的玩耍了。</p>
</li>
<li><p>安装<code>ipconfig</code>命令<br>通过<code>ping</code>命令，可以查看现在虚拟机是否已经连接外网：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ping www.baidu.com</span><br><span class="line">PING www.a.shifen.com (112.34.112.40) 56(84) bytes of data.</span><br><span class="line">64 bytes from 112.34.112.40 (112.34.112.40): icmp_seq=1 ttl=63 time=19.2 ms</span><br><span class="line">64 bytes from 112.34.112.40 (112.34.112.40): icmp_seq=2 ttl=63 time=19.8 ms</span><br></pre></td></tr></table></figure>

<p>如上所示，已经能够成功连接外网，下面所要做的就是利用<code>yum install net-tools</code>命令，安装<code>ipconfig</code>。安装完成后，即可使用<code>ifconfig</code>命令：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]# ifconfig</span><br><span class="line">enp0s3: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 10.0.2.15  netmask 255.255.255.0  broadcast 10.0.2.255</span><br><span class="line">        inet6 fe80::facf:7da3:d61b:6a39  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether 08:00:27:0f:d6:f6  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 7827  bytes 10002300 (9.5 MiB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 3324  bytes 220777 (215.6 KiB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="linux-系统下网卡启动与关闭命令汇总"><a href="#linux-系统下网卡启动与关闭命令汇总" class="headerlink" title="linux 系统下网卡启动与关闭命令汇总"></a>linux 系统下网卡启动与关闭命令汇总</h2><ol>
<li><p>ifup | ifdown {interface}：<br>&emsp;&emsp;ifup与ifdown真是太简单了。这两个程序其实是script而已，它会直接到 /etc/ sysconfig/network-scripts目录下搜索对应的配置文件，例如ifup eth0，它会找出ifcfg-eth0这个文件的内容，然后加以设置。不过，由于这两个程序主要是搜索设置文件（ifcfg-ethx）来进行启动与关闭的，所以在使用前请确定ifcfg-ethx是否真的存在于正确的目录内，否则会启动失败。另外，如果以ifconfig eth0来设置或者是修改了网络接口后，就无法再以ifdown eth0的方式来关闭了。因为ifdown会分析比较目前的网络参数与ifcfg-eth0是否相符，不符的话，就会放弃这次操作。因此，使用ifconfig修改完毕后，应该要以ifconfig eth0 down才能够关闭该接口。</p>
</li>
<li><p>/etc/init.d/network start | stop | restart</p>
</li>
<li><p>service network start | stop | restart</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
        <category>CentOS</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>lilypond配置</title>
    <url>/2020/08/12/lilypond-configure/</url>
    <content><![CDATA[<blockquote>
<p>编写本文的起因是因为随着macOS更新到新版本10.15 Catalina，macOS不再支持32位软件，原来安装的lilypond不能再用，只能安装64位版本的lilypond，但是更新软件后，发现原有的乐谱内有中文的，都无法再成功编译，在查找原因的过程中走了很多弯路，在此做一下记录，顺便将lilypond的一些相关配置都记录一下。</p>
</blockquote>
<a id="more"></a>

<h2 id="1-配置命令行启动lilypond"><a href="#1-配置命令行启动lilypond" class="headerlink" title="1. 配置命令行启动lilypond"></a>1. 配置命令行启动lilypond</h2><p>  正常情况下，安装完lilypond，虽然能够使用Frescobaldi之类的软件调用lilypon，但是直接在shell中用命令行调用lilypond是无法正常使用的。但是最近在处理lilypond出现的各种问题的时候，发现这样很不方便，因此根据官网的一些<a href="http://lilypond.org/macos-x.zh.html" target="_blank" rel="noopener">提示</a>，配置命令行启用lilypond。</p>
<h3 id="1-1-创建执行脚本"><a href="#1-1-创建执行脚本" class="headerlink" title="1.1. 创建执行脚本"></a>1.1. 创建执行脚本</h3><p>  在<code>/usr/local/bin</code>目录里创建文件<code>lilypond</code>并输入以下内容</p>
  <figure class="highlight bash"><figcaption><span>/usr/local/bin/lilypond</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">exec</span> /Applications/LilyPond.app/Contents/Resources/bin/lilypond <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure>

<p>  除了<code>lilypond</code>，还有<code>lilypond-book</code>等命令，可以参照这一步骤，依次创建。</p>
<h3 id="1-2-添加权限"><a href="#1-2-添加权限" class="headerlink" title="1.2. 添加权限"></a>1.2. 添加权限</h3><p>  为上一步中创建的执行脚本添加可执行权限</p>
  <figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line">sudo chmod 755 lilypond</span><br></pre></td></tr></table></figure>

<p>  同样，为其他<code>lilypond</code>相关的可执行脚本创建可执行权限。</p>
<h2 id="2-lilypond中文乱码"><a href="#2-lilypond中文乱码" class="headerlink" title="2. lilypond中文乱码"></a>2. lilypond中文乱码</h2><blockquote>
<p>在执行lilypond编译乐谱的时候，发现在生成pdf的步骤，会出现错误，无法正确识别中文。这应该是由于中文字体缺失导致的，</p>
</blockquote>
<p>  编译过程出现的错误信息如下：</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Converting to &#96;玩够了没有.pdf&#39;...</span><br><span class="line">warning: &#96;(gs -q -dSAFER -dDEVICEWIDTHPOINTS&#x3D;595.28 -dDEVICEHEIGHTPOINTS&#x3D;841.89 -dCompatibilityLevel&#x3D;1.4 -dNOPAUSE -dBATCH -r1200 -sDEVICE&#x3D;pdfwrite -dAutoRotatePages&#x3D;&#x2F;None -dPrinted&#x3D;false -sOutputFile&#x3D;玩够了没有.pdf -c.setpdfwrite -f&#x2F;var&#x2F;folders&#x2F;3p&#x2F;zr3fwznx0pq01hp6c6p1tscr0000gp&#x2F;T&#x2F;&#x2F;lilypond-7gvJNc)&#39; failed (256)</span><br></pre></td></tr></table></figure>

<p>  该问题暂时没有找到彻底的解决方案，只能通过一个曲线救国的方法来解决，即，在编译之前，将文件名改为英文，在编译之后再把文件改回原名。考虑到使用方便，在这里做了一个启动脚本，可以完成这个过程。</p>
  <figure class="highlight bash"><figcaption><span>lilypond启动脚本</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">ARGS_ARRAY=(<span class="string">"<span class="variable">$@</span>"</span>) <span class="comment"># 获取参数列表</span></span><br><span class="line"><span class="built_in">unset</span> <span class="string">"ARGS_ARRAY[<span class="variable">$&#123;#ARGS_ARRAY[@]&#125;</span>-1]"</span> <span class="comment"># 删除最后一个参数，即文件名</span></span><br><span class="line">FILE_PATH=<span class="variable">$&#123;!#&#125;</span> <span class="comment"># 获取最后一个参数，即文件名</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 将参数列表转换为字符串</span></span><br><span class="line">ARGS=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$&#123;ARGS_ARRAY[@]&#125;</span>; <span class="keyword">do</span></span><br><span class="line">  ARGS=<span class="string">"<span class="variable">$ARGS</span> <span class="variable">$i</span>"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 判断文件是否存在，不存在给出提示</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">"<span class="variable">$FILE_PATH</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"[ERROR] File not exists"</span></span><br><span class="line">  <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成临时文件</span></span><br><span class="line">BASEDIR=$(dirname <span class="variable">$FILE_PATH</span>)</span><br><span class="line">FULL_FILE_NAME=$(basename <span class="variable">$FILE_PATH</span>)</span><br><span class="line">SUFFIX=<span class="variable">$&#123;FULL_FILE_NAME#*.&#125;</span></span><br><span class="line">BASE_FILE_NAME=<span class="variable">$&#123;FULL_FILE_NAME%%.*&#125;</span></span><br><span class="line"></span><br><span class="line">TMP_FILE_NAME=$(<span class="built_in">echo</span> -n <span class="variable">$BASE_FILE_NAME</span> | md5sum| awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line"></span><br><span class="line">TMP_FILE_PATH=<span class="variable">$BASEDIR</span>/<span class="variable">$TMP_FILE_NAME</span>.<span class="variable">$SUFFIX</span></span><br><span class="line"></span><br><span class="line">mv <span class="variable">$FILE_PATH</span> <span class="variable">$TMP_FILE_PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在这里插入调用lilypond的语句</span></span><br><span class="line">output=`<span class="built_in">exec</span> /Applications/LilyPond.app/Contents/Resources/bin/lilypond <span class="variable">$ARGS</span> <span class="variable">$TMP_FILE_PATH</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> FILE <span class="keyword">in</span> $(ls <span class="variable">$BASEDIR</span> | grep <span class="variable">$TMP_FILE_NAME</span>); <span class="keyword">do</span></span><br><span class="line">  TMP_SUFFIX=<span class="variable">$&#123;FILE#*.&#125;</span></span><br><span class="line">  SRC=<span class="variable">$BASEDIR</span>/<span class="variable">$TMP_FILE_NAME</span>.<span class="variable">$TMP_SUFFIX</span></span><br><span class="line">  TAR=<span class="variable">$BASEDIR</span>/<span class="variable">$BASE_FILE_NAME</span>.<span class="variable">$TMP_SUFFIX</span></span><br><span class="line">  mv <span class="variable">$SRC</span> <span class="variable">$TAR</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>lilypond</category>
      </categories>
      <tags>
        <tag>lilypond</tag>
        <tag>中文字体</tag>
        <tag>Catalina</tag>
      </tags>
  </entry>
  <entry>
    <title>使hexo(next)支持流程图</title>
    <url>/2020/08/12/hexo-flowchart-mermaid/</url>
    <content><![CDATA[<blockquote>
<p>使hexo支持流程图，该方案基于<code>mermaid.js</code></p>
</blockquote>
<a id="more"></a>

<blockquote>
<p>本文参考 <a href="https://github.com/webappdevelp/hexo-filter-mermaid-diagrams" target="_blank" rel="noopener">hexo-filter-mermaid-diagrams</a><br>本文基于next主题配置，而next模板已经内置了对<code>mermaid.js</code>支持。</p>
</blockquote>
<h2 id="1-安装插件"><a href="#1-安装插件" class="headerlink" title="1. 安装插件"></a>1. 安装插件</h2><p>  在站点根目录执行如下命令，安装插件</p>
  <figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line">npm install hexo-filter-mermaid-diagrams</span><br></pre></td></tr></table></figure>

<h2 id="2-编辑配置"><a href="#2-编辑配置" class="headerlink" title="2. 编辑配置"></a>2. 编辑配置</h2><h3 id="2-1-站点配置"><a href="#2-1-站点配置" class="headerlink" title="2.1 站点配置"></a>2.1 站点配置</h3><p>  配置站点<code>_config.yml</code>文件，在文件最后添加如下内容：</p>
  <figure class="highlight yml"><figcaption><span>_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># mermaid chart</span></span><br><span class="line"><span class="attr">mermaid:</span> <span class="comment">## mermaid url https://github.com/knsv/mermaid</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">true</span>  <span class="comment"># default true</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">"7.1.2"</span> <span class="comment"># default v7.1.2</span></span><br><span class="line">  <span class="attr">options:</span>  <span class="comment"># find more api options from https://github.com/knsv/mermaid/blob/master/src/mermaidAPI.js</span></span><br><span class="line">    <span class="comment">#startOnload: true  // default true</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-主题配置"><a href="#2-2-主题配置" class="headerlink" title="2.2 主题配置"></a>2.2 主题配置</h3><p>  配置主题<code>_config.yml</code>文件，在文件中找到如下内容：</p>
  <figure class="highlight yml"><figcaption><span>_config.yml</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="comment"># Mermaid tag</span></span><br><span class="line"><span class="attr">mermaid:</span></span><br><span class="line">  <span class="attr">enable:</span> <span class="literal">false</span></span><br><span class="line">  <span class="comment"># Available themes: default | dark | forest | neutral</span></span><br><span class="line">  <span class="attr">theme:</span> <span class="string">forest</span></span><br></pre></td></tr></table></figure>

<p>  将其中的<code>enable: false</code>设置为<code>true</code>，并根据需要更改主题</p>
<h2 id="3-mermaid语法"><a href="#3-mermaid语法" class="headerlink" title="3. mermaid语法"></a>3. mermaid语法</h2><blockquote>
<p>如果想要测试<code>mermaid</code>语法，可以使用<a href="https://mermaid-js.github.io/mermaid-live-editor/#/edit/eyJjb2RlIjoiZ3JhcGggVERcbkFbQ2hyaXN0bWFzXSAtLT58R2V0IG1vbmV5fCBCKEdvIHNob3BwaW5nKVxuQiAtLT4gQ3tMZXQgbWUgdGhpbmt9XG5DIC0tPnxPbmV8IERbTGFwdG9wXVxuQyAtLT58VHdvfCBFW2lQaG9uZV1cbkMgLS0-fFRocmVlfCBGW2ZhOmZhLWNhciBDYXJdXG4iLCJtZXJtYWlkIjp7InRoZW1lIjoiZGVmYXVsdCJ9fQ" target="_blank" rel="noopener">mermaid在线编辑器</a><br>语法参考<a href="http://blog.lisp4fun.com/2017/11/21/mermaiduse" target="_blank" rel="noopener">Markdown 绘图插件之 Mermaid 语法</a></p>
</blockquote>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>next</tag>
        <tag>flowchart</tag>
        <tag>mermaid</tag>
      </tags>
  </entry>
  <entry>
    <title>在macOS中配置zsh作为shell</title>
    <url>/2020/08/11/macos-zsh-configure/</url>
    <content><![CDATA[<blockquote>
<p>随着macOS更新新版本，在打开终端的时候，提示让使用zsh作为shell，本文内容主要是调整为zsh之后的一些配置</p>
</blockquote>
<a id="more"></a>

<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1. 前言"></a>1. 前言</h2><p>  前段时间更新了以下macOS，更新之后发现打开终端之后，会有如下提示：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">The default interactive shell is now zsh.</span><br><span class="line">To update your account to use zsh, please run `chsh -s /bin/zsh`.</span><br><span class="line">For more details, please visit https://support.apple.com/kb/HT208050.</span><br></pre></td></tr></table></figure>

<p>  根据提示内容，新版本的终端会默认使用zsh替代以前的bash。本文就是记录一下zsh的配置过程。</p>
<blockquote>
<ul>
<li>本文内容均基于macOS 10.15 (Catalina)</li>
<li>zsh配置文件的路径为：<code>~/.zshrc</code></li>
</ul>
</blockquote>
<h2 id="2-安装"><a href="#2-安装" class="headerlink" title="2. 安装"></a>2. 安装</h2><p>  macOS默认已经安装过zsh，以下为更新方法：</p>
  <figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看zsh版本</span></span><br><span class="line">zsh --version</span><br><span class="line"><span class="comment"># 更新zsh</span></span><br><span class="line">brew install zsh zsh-completions</span><br></pre></td></tr></table></figure>

<h2 id="3-使用oh-my-zsh"><a href="#3-使用oh-my-zsh" class="headerlink" title="3. 使用oh my zsh"></a>3. 使用oh my zsh</h2><p>  oh my zsh以下简称omz</p>
<h3 id="3-1-安装"><a href="#3-1-安装" class="headerlink" title="3.1. 安装"></a>3.1. 安装</h3><p>  安装omz可以使用<code>curl</code>或者<code>wget</code>，方法如下：</p>
  <figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用curl</span></span><br><span class="line">sh -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用wget</span></span><br><span class="line">sh -c <span class="string">"<span class="variable">$(wget https://raw.github.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -)</span>"</span></span><br></pre></td></tr></table></figure>

<p>  安装完成后会自动生效，如果没有生效，可以重启shell。</p>
<h3 id="3-2-安装主题"><a href="#3-2-安装主题" class="headerlink" title="3.2. 安装主题"></a>3.2. 安装主题</h3><p>  这里选择的主题是<code>powerlevel10k</code></p>
<h4 id="3-2-1-安装powerlevel10k"><a href="#3-2-1-安装powerlevel10k" class="headerlink" title="3.2.1. 安装powerlevel10k"></a>3.2.1. 安装<code>powerlevel10k</code></h4>  <figure class="highlight zsh"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth=1 https://gitee.com/romkatv/powerlevel10k.git <span class="variable">$&#123;ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom&#125;</span>/themes/powerlevel10k</span><br></pre></td></tr></table></figure>

<h4 id="3-2-2-更改zsh配置"><a href="#3-2-2-更改zsh配置" class="headerlink" title="3.2.2. 更改zsh配置"></a>3.2.2. 更改zsh配置</h4><p>  修改zsh配置文件<code>~/.zshrc</code>，设置主题为<code>ZSH_THEME=&quot;powerlevel10k/powerlevel10k&quot;</code></p>
<p>  使用<code>p10k configure</code>命令，进行设置</p>
<h4 id="3-2-3-导入系统命令"><a href="#3-2-3-导入系统命令" class="headerlink" title="3.2.3. 导入系统命令"></a>3.2.3. 导入系统命令</h4><p>  更新zsh之后，原有的命令可能无法使用，找到以前的<code>~/.bash_profile</code>文件，将其中的内容选择需要的粘贴在<code>~/.zshrc</code>中。</p>
<h4 id="3-2-4-VS-Code中设置Terminal"><a href="#3-2-4-VS-Code中设置Terminal" class="headerlink" title="3.2.4. VS Code中设置Terminal"></a>3.2.4. VS Code中设置Terminal</h4><p>  打开VS Code的设置，修改配置</p>
<p>  <code>&quot;terminal.integrated.shell.osx&quot;: &quot;zsh&quot;</code></p>
]]></content>
      <categories>
        <category>macOS</category>
      </categories>
      <tags>
        <tag>macOS</tag>
        <tag>zsh</tag>
        <tag>configure</tag>
      </tags>
  </entry>
  <entry>
    <title>Markdown的一些用法</title>
    <url>/2019/03/14/markdown-usage/</url>
    <content><![CDATA[<blockquote>
<p>记录了本人在使用markdown过程中遇到的一些小疑问  </p>
</blockquote>
<a id="more"></a>

<h2 id="1-换行"><a href="#1-换行" class="headerlink" title="1. 换行"></a>1. 换行</h2><ol>
<li><p>使用<code>&lt;br/&gt;</code>标签</p>
</li>
<li><p>在末尾使用两个空格，然后回车</p>
</li>
</ol>
<h2 id="2-首行缩进"><a href="#2-首行缩进" class="headerlink" title="2. 首行缩进"></a>2. 首行缩进</h2><p>使用特殊占位符</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&amp;ensp; 或&amp;#8194; &#x2F;&#x2F;半角</span><br><span class="line">&amp;emsp; 或&amp;#8195; &#x2F;&#x2F;全角</span><br><span class="line">&amp;nbsp; 或&amp;#160;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意不要少了<code>;</code></p>
</blockquote>
<h2 id="3-自定义锚点"><a href="#3-自定义锚点" class="headerlink" title="3. 自定义锚点"></a>3. 自定义锚点</h2><blockquote>
<p>正常情况下，Markdown支持页内跳转，但是只支持针对标题的页内跳转，但是我们可以通过html标签的形式，自定义id，从而实现跳转到自定义锚点</p>
</blockquote>
<p>在需要锚点的地方添加如下代码</p>
<span id='test-id' />

<figure class="highlight html"><figcaption><span>自定义锚点</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">'test-id'</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>在需要跳转的地方只需要参照Markdown页内跳转的基本用法即可，如：</p>
<figure class="highlight md"><table><tr><td class="code"><pre><span class="line">[<span class="string">测试页内跳转</span>](<span class="link">#test-id</span>)</span><br></pre></td></tr></table></figure>

<p>实际效果：<br><a href="#test-id">测试页内跳转</a></p>
<h2 id="4-hexo-next主题中内建标签的使用"><a href="#4-hexo-next主题中内建标签的使用" class="headerlink" title="4. hexo next主题中内建标签的使用"></a>4. hexo next主题中内建标签的使用</h2><blockquote>
<p>本条目仅针对使用hexo搭建blog，且使用的是next主题情况下的内建标签的使用</p>
</blockquote>
<p>以下样式标签出现在<a href="https://codepen.io/superjaberwocky/pen/AXdEWj" target="_blank" rel="noopener">Bootstrap Callout</a>说明中。</p>
<figure class="highlight plain"><figcaption><span>在hexo文章中的使用方式</span></figcaption><table><tr><td class="code"><pre><span class="line">&#123;% note class_name %&#125; 内容 &#123;% endnote %&#125;</span><br></pre></td></tr></table></figure>

<p>其中<code>class_name</code>可以使用以下列表中的值：</p>
<ul>
<li>default</li>
<li>primary</li>
<li>success</li>
<li>info</li>
<li>warning</li>
<li>danger</li>
</ul>
<p>效果展示：</p>
<div class="note default">
            <p>Default Callout </p>
          </div>
<div class="note primary">
            <p>Primary Callout </p>
          </div>
<div class="note success">
            <p>Success Callout </p>
          </div>
<div class="note info">
            <p>Info Callout </p>
          </div>
<div class="note warning">
            <p>Warning Callout </p>
          </div>
<div class="note danger">
            <p>Danger Callout </p>
          </div>

<h2 id="5-内容折叠"><a href="#5-内容折叠" class="headerlink" title="5. 内容折叠"></a>5. 内容折叠</h2><figure class="highlight html"><figcaption><span>语法</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">summary</span>&gt;</span>点击时的区域标题：点击查看详细内容<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">p</span>&gt;</span> - 测试 测试测试<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">pre</span>&gt;</span><span class="tag">&lt;<span class="name">code</span>&gt;</span>title，value，callBack可以缺省<span class="tag">&lt;/<span class="name">code</span>&gt;</span><span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>或：</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">details</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">summary</span>&gt;</span>点击时的区域标题：点击查看详细内容<span class="tag">&lt;/<span class="name">summary</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  ```</span><br><span class="line">    测试内容</span><br><span class="line">  ```</span><br><span class="line">  </span><br><span class="line"><span class="tag">&lt;/<span class="name">details</span>&gt;</span></span><br></pre></td></tr></table></figure>

<details>
  <summary>点击时的区域标题：点击查看详细内容</summary>
  <p> - 测试 测试测试</p>
  <pre><code>title，value，callBack可以缺省</code></pre>
</details>

<details>
  <summary>测试内容折叠</summary>

  <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"cn.hnpi.contentprovider"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">".MyContentProvider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:authorities</span>=<span class="string">"cn.hnpi.contentprovider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:enabled</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">"true"</span>&gt;</span><span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

</details>
]]></content>
      <categories>
        <category>markdown</category>
      </categories>
      <tags>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>next主题的个性配置</title>
    <url>/2020/06/16/next-setting/</url>
    <content><![CDATA[<blockquote>
<p>记录next中的一些个性设置，保证每次更新next主题都能够快速完成主题的个性化设置</p>
</blockquote>
<a id="more"></a>

<h2 id="配置data-file"><a href="#配置data-file" class="headerlink" title="配置data_file"></a>配置data_file</h2><blockquote>
<p>data_file是hexo的一个特性，能够利用data_file，保存个性化的配置文件，不用再更改next的配置文件_config.yml，从而保证每次使用git pull都可以顺利拉取更新文件</p>
</blockquote>
<ol>
<li><p>在<code>hexo/source/_data</code>目录下创建<code>next.yml</code>文件（如果没有_data目录，则手动创建即可）</p>
</li>
<li><p>将原本配置在主题配置文件<code>next/_config.yml</code>文件中的配置，拷贝到上一步创建的<code>next.yml</code>文件中</p>
</li>
<li><p>在<code>next.yml</code>文件中，有一个配置项：<code>override: false</code>，如果需要每次更新后，用<code>next.yml</code>完全替代主题配置文件<code>next/_config.yml</code>中的全部配置项，而不是合并配置项，那么可以改为将该配置改为<code>true</code></p>
</li>
</ol>
<blockquote>
<p>注意，部分模块的配置可能没法使用该方法，因为这些模块只会从hexo的config中读取配置，例如<code>hexo-server</code></p>
</blockquote>
<h2 id="自定义版权签名信息"><a href="#自定义版权签名信息" class="headerlink" title="自定义版权签名信息"></a>自定义版权签名信息</h2><ol>
<li><p>创建版权信息模板：</p>
<p>在<code>next/layout/_partials/post</code>目录下创建<code>my-copyright.swig</code>文件，文件内容编辑如下：</p>
 <figure class="highlight html"><figcaption><span>my-copyright.swig</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"post_my_copyright"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- JS库 可修改路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/sweetalert/dist/sweetalert.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>本文标题:<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for(page.path) &#125;&#125;"</span>&gt;</span>&#123;&#123; page.title &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>文章作者:<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span> <span class="attr">title</span>=<span class="string">"访问 &#123;&#123; theme.author &#125;&#125; 的个人博客"</span>&gt;</span>&#123;&#123; theme.author &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>发布时间:<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;&#123; page.date.format("YYYY年MM月DD日 - HH:MM") &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>最后更新:<span class="tag">&lt;/<span class="name">span</span>&gt;</span>&#123;&#123; page.updated.format("YYYY年MM月DD日 - HH:MM") &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>原始链接:<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"&#123;&#123; url_for(page.path) &#125;&#125;"</span> <span class="attr">title</span>=<span class="string">"&#123;&#123; page.title &#125;&#125;"</span>&gt;</span>&#123;&#123; page.permalink &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"copy-path"</span>  <span class="attr">title</span>=<span class="string">"点击复制文章链接"</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-clipboard"</span> <span class="attr">data-clipboard-text</span>=<span class="string">"&#123;&#123; page.permalink &#125;&#125;"</span>  <span class="attr">aria-label</span>=<span class="string">"复制成功！"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>许可协议:<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">i</span> <span class="attr">class</span>=<span class="string">"fa fa-creative-commons"</span>&gt;</span><span class="tag">&lt;/<span class="name">i</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">rel</span>=<span class="string">"license"</span> <span class="attr">href</span>=<span class="string">"https://creativecommons.org/licenses/by-nc-nd/4.0/"</span> <span class="attr">target</span>=<span class="string">"_blank"</span> <span class="attr">title</span>=<span class="string">"Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)"</span>&gt;</span>署名-非商业性使用-禁止演绎 4.0 国际<span class="tag">&lt;/<span class="name">a</span>&gt;</span> 转载请保留原文链接及作者。<span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">    <span class="keyword">var</span> clipboard = <span class="keyword">new</span> Clipboard(<span class="string">'.fa-clipboard'</span>);</span></span><br><span class="line"><span class="javascript">    $(<span class="string">".fa-clipboard"</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">    clipboard.on(<span class="string">'success'</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span>&#123;</span></span><br><span class="line">        swal(&#123;</span><br><span class="line"><span class="actionscript">        title: <span class="string">""</span>,</span></span><br><span class="line"><span class="actionscript">        text: <span class="string">'复制成功'</span>,</span></span><br><span class="line"><span class="actionscript">        icon: <span class="string">"success"</span>,</span></span><br><span class="line"><span class="actionscript">        showConfirmButton: <span class="literal">true</span></span></span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">    &#125;);  </span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置版权信息模板的样式</p>
<p> 在<code>next/source/css/_common/components/post</code>目录下创建<code>post-my-copyright.styl</code>文件，文件内容编辑如下：</p>
 <figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.post_my_copyright</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">85%</span>;</span><br><span class="line">    <span class="attribute">max-width</span>: <span class="number">45em</span>;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">2.8em</span> auto <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0.5em</span> <span class="number">1.0em</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid <span class="number">#d3d3d3</span>;</span><br><span class="line">    <span class="attribute">font-size</span>: <span class="number">0.93rem</span>;</span><br><span class="line">    <span class="attribute">line-height</span>: <span class="number">1.6em</span>;</span><br><span class="line">    <span class="attribute">word-break</span>: break-all;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">rgba</span>(<span class="number">255</span>,<span class="number">255</span>,<span class="number">255</span>,<span class="number">0.4</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-tag">p</span>&#123; <span class="attribute">margin</span>:<span class="number">0</span>; &#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-tag">span</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: inline-block;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">5.2em</span>;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#b5b5b5</span>;</span><br><span class="line">    <span class="attribute">font-weight</span>: bold;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-class">.raw</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">1em</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">5em</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#808080</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>:<span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#a3d2a3</span>;</span><br><span class="line">    <span class="attribute">text-decoration</span>: underline;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span><span class="selector-pseudo">:hover</span> <span class="selector-class">.fa-clipboard</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-class">.post-url</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">font-weight</span>: normal;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-class">.copy-path</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">1em</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">1em</span>;</span><br><span class="line">    +mobile()&#123; display:none; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.post_my_copyright</span> <span class="selector-class">.copy-path</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="number">#808080</span>;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>next/layout/_macro/post.swig</code>文件</p>
<p> 找到文件内以下位置：</p>
 <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;#####################&#125;</span><br><span class="line">&#123;### END POST BODY ###&#125;</span><br><span class="line">&#123;#####################&#125;</span><br></pre></td></tr></table></figure>

<p> 在该内容的下方，找到</p>
 <figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;%- if not is_index %&#125;</span><br></pre></td></tr></table></figure>

<p> 在该<code>if</code>片段内合适位置，添加：</p>
 <figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;%- if page.copyright %&#125;</span><br><span class="line">  &#123;&#123; partial('_partials/post/my-copyright.swig') &#125;&#125;</span><br><span class="line">&#123;%- endif %&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>导入版权信息样式配置：</p>
<p>在<code>next/source/css/_common/components/post/post.styl</code>文件末尾，添加<code>@import &quot;post-my-copyright&quot;</code></p>
</li>
</ol>
<h2 id="设置主题字体大小"><a href="#设置主题字体大小" class="headerlink" title="设置主题字体大小"></a>设置主题字体大小</h2><p>打开<code>next/source/css/_variables/base.styl</code>文件，找到<code>Font size</code>部分，修改字体大小：</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">$font-size-base           = (hexo-config('font.enable') and hexo-config('font.global.size') is a 'unit') ? unit(hexo-config('font.global.size'), em) : 0.85em;</span><br><span class="line">$font-size-smallest       = .75em;</span><br><span class="line">$font-size-smaller        = .8125em;</span><br><span class="line">$font-size-small          = .875em;</span><br><span class="line">$font-size-medium         = 1em;</span><br><span class="line">$font-size-large          = 1.125em;</span><br><span class="line">$font-size-larger         = 1.25em;</span><br><span class="line">$font-size-largest        = 1.375em;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>hexo</category>
        <category>next</category>
      </categories>
      <tags>
        <tag>next</tag>
        <tag>data_file</tag>
        <tag>setting</tag>
      </tags>
  </entry>
  <entry>
    <title>更改源以更新不再支持的Ubuntu旧版本</title>
    <url>/2020/06/21/ubuntu-no-longer-supported/</url>
    <content><![CDATA[<blockquote>
<p>今天更新Ubuntu的时候，发现无法通过<code>apt</code>更新，提示是该Ubuntu版本已经不再支持，然而更新版本也好，更新软件也好，都无法使用apt的话，也就无法更新到新的Ubuntu版本，进入了一个死循环</p>
</blockquote>
<a id="more"></a>

<h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><p>  Ubuntu 对各个版本的技术支持时间是不同的，在<a href="https://ubuntu.com/about/release-cycle" target="_blank" rel="noopener">Ubuntu Release生命周期</a>页面上，有近期常用Ubuntu版本的支持情况，比如：<br>  <a href="https://pic.downk.cc/item/5eeeefd914195aa5941cba06.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeeefd914195aa5941cba06.jpg" alt="Ubuntu Release生命周期"></a><br>  对于已经不再支持的版本，会将其更新源统一转移至Old-Release中进行管理</p>
<h2 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h2><p>  编辑<code>/etc/apt/sources.list</code>文件<br>  将<code>deb http://us.archive.ubuntu.com/ubuntu eoan-security main restricted</code>类似于这样的语句中的<code>us.archive</code>都修改为<code>old-releases</code>，修改后类似于：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">deb http://old-releases.ubuntu.com/ubuntu/ xxxx main restricted universe multiverse</span><br><span class="line">deb http://old-releases.ubuntu.com/ubuntu/ xxxx-security main restricted universe multiverse</span><br><span class="line">deb http://old-releases.ubuntu.com/ubuntu/ xxxx-updates main restricted universe multiverse</span><br><span class="line">deb http://old-releases.ubuntu.com/ubuntu/ xxxx-proposed main restricted universe multiverse</span><br><span class="line">deb http://old-releases.ubuntu.com/ubuntu/ xxxx-backports main restricted universe multiverse</span><br><span class="line">deb-src http://old-releases.ubuntu.com/ubuntu/ xxxx main restricted universe multiverse</span><br><span class="line">deb-src http://old-releases.ubuntu.com/ubuntu/ xxxx-security main restricted universe multiverse</span><br><span class="line">deb-src http://old-releases.ubuntu.com/ubuntu/ xxxx-updates main restricted universe multiverse</span><br><span class="line">deb-src http://old-releases.ubuntu.com/ubuntu/ xxxx-proposed main restricted universe multiverse</span><br><span class="line">deb-src http://old-releases.ubuntu.com/ubuntu/ xxxx-backports main restricted universe multiverse</span><br></pre></td></tr></table></figure>

<p>  其中xxxx部分，是各个Ubuntu版本的代号，可以使用命令<code>lsb_release -a</code>查看，例如：</p>
  <figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">root@vultr:~# lsb_release -a</span><br><span class="line">No LSB modules are available.</span><br><span class="line">Distributor ID: Ubuntu</span><br><span class="line">Description: Ubuntu 19.10</span><br><span class="line">Release: 19.10</span><br><span class="line">Codename: eoan</span><br></pre></td></tr></table></figure>

<p>  这里的<code>eoan</code>，就是版本代号</p>
]]></content>
      <categories>
        <category>Linux</category>
        <category>Ubuntu</category>
      </categories>
      <tags>
        <tag>Ubuntu</tag>
        <tag>source</tag>
        <tag>源更改</tag>
        <tag>no-longer-supported</tag>
        <tag>old-releases</tag>
        <tag>旧版本</tag>
      </tags>
  </entry>
  <entry>
    <title>微信小程序使用component来制作自定义导航栏</title>
    <url>/2020/06/20/wechat-miniprogram-navigation-bar-by-component/</url>
    <content><![CDATA[<blockquote>
<p>最近在制作微信小程序的时候，遇到了一个需求：希望能够根据用户角色不同，显示不同的导航栏。最初想到的方案，是利用component制作一个导航栏，然后在每个需要导航栏的page，引用这个component，</p>
</blockquote>
]]></content>
      <categories>
        <category>wechat-miniprogram</category>
      </categories>
      <tags>
        <tag>wechat</tag>
        <tag>miniprogram</tag>
        <tag>component</tag>
      </tags>
  </entry>
  <entry>
    <title>科学上网-Trojan搭建指南</title>
    <url>/2020/06/21/trojan-config/</url>
    <content><![CDATA[<blockquote>
<p>科学上网，在科学上网的高峰上默默攀登~<br>本文介绍了如何使用Trojan进行科学上网，相较V2ray，Trojan具有更安全，更高速的特性，更符合国情</p>
</blockquote>
<a id="more"></a>

<blockquote>
<p>已有域外服务器和域名的，并且完成DNS解析的，可以跳过1-3步骤，注意云服务器版本要在<code>Ubuntu 16.04</code> or <code>Debian 9</code> or <code>CentOS 7</code>及以上</p>
</blockquote>
<h2 id="1-购买服务器"><a href="#1-购买服务器" class="headerlink" title="1. 购买服务器"></a>1. 购买服务器</h2><p>  过程略，大家可以根据各自需求，选择国外的服务器提供商，购买云服务器。我个人使用的是<a href="https://www.vultr.com/" target="_blank" rel="noopener">Vultr</a>，因为Vultr提供的服务器是按小时收费的，可以在不用的时候关闭服务器，更加灵活弹性。而且Vultr提供的服务器，最便宜的有 $5/mon 的，非常划算。</p>
<h2 id="2-购买域名"><a href="#2-购买域名" class="headerlink" title="2. 购买域名"></a>2. 购买域名</h2><p>  过程略，大家可以根据自己需求，选择国外的域名服务商，购买域名，不推荐国内的域名服务商。我个人使用的是<a href="https://www.namecheap.com/" target="_blank" rel="noopener">namecheap</a>，也可以使用<a href="http://www.freenom.com" target="_blank" rel="noopener">freenom</a>（特定几个域名后缀，比如ga，提供最长12个月的免费服务，而且可以在时间快要到期的时候继续延时）。不过我不使用freenom的原因是因为freenom的网页实在是太难连接了！！！namecheap购买的域名，最便宜可以到 $3.88/yr ，可以买10年，而且有些特价域名，可能不到 $1/yr。</p>
<h2 id="3-构建DNS解析服务"><a href="#3-构建DNS解析服务" class="headerlink" title="3. 构建DNS解析服务"></a>3. 构建DNS解析服务</h2><p>  使用<a href="https://www.cloudflare.com/" target="_blank" rel="noopener">cloudflare</a>进行DNS解析，好处是可以进行IP伪装，掩盖云服务器的真实IP地址。</p>
<h3 id="3-1-注册cloudflare会员"><a href="#3-1-注册cloudflare会员" class="headerlink" title="3.1 注册cloudflare会员"></a>3.1 注册cloudflare会员</h3><p>  注册过程略</p>
<h3 id="3-2-添加站点"><a href="#3-2-添加站点" class="headerlink" title="3.2 添加站点"></a>3.2 添加站点</h3><p>  注册之后，登录cloudflare，应该会显示如下页面：<br>  <a href="https://pic.downk.cc/item/5eeed99e14195aa594fdcf49.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeed99e14195aa594fdcf49.jpg" alt="cloudflare 用户控制面板"></a><br>  点击添加站点，在输入框里填入刚才第二步中购买的域名，然后点击添加站点：<br>  <a href="https://pic.downk.cc/item/5eeedbb114195aa594007563.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeedbb114195aa594007563.jpg" alt="添加站点"></a><br>  在名称那一栏填写路径，这里的路径就是域名前面的那一段，比如<code>www.baidu.com</code>这里的<code>www</code>，在IPv4地址那一栏填写刚才第一步购买的云服务器的IP地址，将小云朵点成灰色。然后点击添加记录，点击继续。<br>  <a href="https://pic.downk.cc/item/5eeedeec14195aa59404ab07.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeedeec14195aa59404ab07.jpg" alt="添加DNS解析记录"></a></p>
<blockquote>
<p>注意：这里我们通常添加两个解析，名称里一个是域名，一个是<code>www</code>，IPv4里都是云服务器的IP地址。另外，那个小云朵一定要点成灰色，不要橘色，否则会导致SSL错误，无法正常代理。</p>
</blockquote>
<p>  回到第二步的域名提供商的网站，在域名设置里，找到修改DNS，或者是修改nameserver的地方，将两个DNS服务器修改为下图中的<code>may.ns.cloudflare.com</code>和<code>roan.ns.cloudflare.com</code><br>  <a href="https://pic.downk.cc/item/5eeedfeb14195aa59405e0c9.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeedfeb14195aa59405e0c9.jpg" alt="更改DNS服务器"></a><br>  例如我所使用的namecheap，操作如下：<br>  <a href="https://pic.downk.cc/item/5eeee27914195aa594092220.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeee27914195aa594092220.jpg" alt="进入域名管理"></a><br>  <a href="https://pic.downk.cc/item/5eeee27914195aa594092224.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeee27914195aa594092224.jpg" alt="更改域名解析服务器"></a></p>
<h2 id="4-VPS服务器部署"><a href="#4-VPS服务器部署" class="headerlink" title="4. VPS服务器部署"></a>4. VPS服务器部署</h2><blockquote>
<p>这里需要使用一个远程连接工具连接云服务器，推荐使用XShell，用法教程很多，这里不再介绍</p>
</blockquote>
<h3 id="4-1-创建用户账户"><a href="#4-1-创建用户账户" class="headerlink" title="4.1 创建用户账户"></a>4.1 创建用户账户</h3><p>  为了系统安全，一般不建议直接使用root用户对系统做设置，而vultr默认只有root用户，故可以自己新建一个非root但是有sudo权限的用户继续后面的操作，代码如下所示，请不要复制 <code>#</code> 及以后内容</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo useradd -m -s /bin/bash trojanuser <span class="comment"># 添加用户</span></span><br><span class="line">sudo passwd trojanuser <span class="comment"># 设置密码</span></span><br><span class="line">sudo usermod -G sudo trojanuser <span class="comment"># 设置用户sudo权限</span></span><br><span class="line">su -l trojanuser <span class="comment"># 切换用户</span></span><br></pre></td></tr></table></figure>

<p>  注意：在设置密码的时候，Linux系统的特性是不会显示任何提示的，包括 <code>*</code> 之类的符号，所以不要以为是输入密码没有反应，如图所示：<br>  <a href="https://pic.downk.cc/item/5eeee62714195aa5940ee0ca.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeee62714195aa5940ee0ca.jpg" alt="设置用户密码"></a></p>
<h3 id="4-2-创建服务账户"><a href="#4-2-创建服务账户" class="headerlink" title="4.2 创建服务账户"></a>4.2 创建服务账户</h3><p>  Trojan是需要占用443端口，使用https协议，所以必然是要安装证书的。本教程使用acme.sh为Trojan生成证书，并配置了acme.sh的自动更新，包括代码和证书的更新。一方面，既然有配置自动更新就有可能出各种问题，毕竟你对更新之后的代码和证书是否可用一无所知。另一方面，acme.sh和Trojan均为开源软件，不一定值得信赖。基于此，为了降低acme.sh和Trojan对系统的影响和其相互影响，故需要单独为acme.sh和Trojan建立没有sudo权限的用户，从而降低风险。<br>  这里我们创建两个用户，分别为trojan和acme。其中用户trojan只需要运行trojan服务，无需登录，也无需家目录，故设置为系统用户即可。这里将用户acme也设置为系统用户，但是区别在于acme需要配置acme.sh，故需要家目录。注意到，我并未给用户acme设置密码，所以该用户也不能登录，只能通过其他已经登录的用户切换过去，这样尽可能的保证了系统的安全与任务的独立。因为trojan和acme都需要读写证书文件，所以将acme和trojan添加到同一个用户组certusers，待申请到证书后将证书所有权交给用户组certusers并允许组内用户访问即可。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo groupadd certusers</span><br><span class="line">sudo useradd -r -M -G certusers trojan</span><br><span class="line">sudo useradd -r -m -G certusers acme</span><br></pre></td></tr></table></figure>

<h3 id="4-3-安装依赖"><a href="#4-3-安装依赖" class="headerlink" title="4.3 安装依赖"></a>4.3 安装依赖</h3><blockquote>
<p>由于Debian系列系统和CentOS系列系统使用不同的包管理软件，所以安装软件的命令不一样，下面两个小节自己对照自己系统选择命令。</p>
</blockquote>
<h4 id="4-3-1-Ubuntu-or-Debian"><a href="#4-3-1-Ubuntu-or-Debian" class="headerlink" title="4.3.1 Ubuntu or Debian"></a>4.3.1 Ubuntu or Debian</h4><h5 id="4-3-1-1-更新源"><a href="#4-3-1-1-更新源" class="headerlink" title="4.3.1.1 更新源"></a>4.3.1.1 更新源</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt update</span><br><span class="line">sudo apt upgrade -y</span><br></pre></td></tr></table></figure>

<h5 id="4-3-1-2-安装acme-sh需要的依赖"><a href="#4-3-1-2-安装acme-sh需要的依赖" class="headerlink" title="4.3.1.2 安装acme.sh需要的依赖"></a>4.3.1.2 安装acme.sh需要的依赖</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install -y socat cron curl</span><br></pre></td></tr></table></figure>

<h5 id="4-3-1-3-启动crontab"><a href="#4-3-1-3-启动crontab" class="headerlink" title="4.3.1.3 启动crontab"></a>4.3.1.3 启动crontab</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl start cron</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> cron</span><br></pre></td></tr></table></figure>

<h5 id="4-3-1-4-安装Trojan需要的依赖"><a href="#4-3-1-4-安装Trojan需要的依赖" class="headerlink" title="4.3.1.4 安装Trojan需要的依赖"></a>4.3.1.4 安装Trojan需要的依赖</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install -y libcap2-bin xz-utils nano</span><br></pre></td></tr></table></figure>

<h5 id="4-3-1-4-安装Nginx"><a href="#4-3-1-4-安装Nginx" class="headerlink" title="4.3.1.4 安装Nginx"></a>4.3.1.4 安装Nginx</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install -y nginx</span><br></pre></td></tr></table></figure>

<h4 id="4-3-2-CentOS"><a href="#4-3-2-CentOS" class="headerlink" title="4.3.2 CentOS"></a>4.3.2 CentOS</h4><h5 id="4-3-2-1-安装acme-sh需要的依赖"><a href="#4-3-2-1-安装acme-sh需要的依赖" class="headerlink" title="4.3.2.1 安装acme.sh需要的依赖"></a>4.3.2.1 安装acme.sh需要的依赖</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y socat cronie curl</span><br></pre></td></tr></table></figure>

<h5 id="4-3-2-2-启动crontab"><a href="#4-3-2-2-启动crontab" class="headerlink" title="4.3.2.2 启动crontab"></a>4.3.2.2 启动crontab</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl start crond</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> crond</span><br></pre></td></tr></table></figure>

<h5 id="4-3-2-3-安装Trojan需要的依赖"><a href="#4-3-2-3-安装Trojan需要的依赖" class="headerlink" title="4.3.2.3 安装Trojan需要的依赖"></a>4.3.2.3 安装Trojan需要的依赖</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y xz nano</span><br></pre></td></tr></table></figure>

<h5 id="4-3-2-4-安装Nginx"><a href="#4-3-2-4-安装Nginx" class="headerlink" title="4.3.2.4 安装Nginx"></a>4.3.2.4 安装Nginx</h5>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y nginx</span><br></pre></td></tr></table></figure>

<h3 id="4-4-创建证书文件"><a href="#4-4-创建证书文件" class="headerlink" title="4.4 创建证书文件"></a>4.4 创建证书文件</h3><h4 id="4-4-1-新建一个文件夹-usr-local-etc-certfiles用于存放证书"><a href="#4-4-1-新建一个文件夹-usr-local-etc-certfiles用于存放证书" class="headerlink" title="4.4.1 新建一个文件夹/usr/local/etc/certfiles用于存放证书"></a>4.4.1 新建一个文件夹<code>/usr/local/etc/certfiles</code>用于存放证书</h4>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mkdir /usr/<span class="built_in">local</span>/etc/certfiles</span><br></pre></td></tr></table></figure>

<h4 id="4-4-2-将证书文件夹所有者改为acme，使得用户acme有权限写入证书"><a href="#4-4-2-将证书文件夹所有者改为acme，使得用户acme有权限写入证书" class="headerlink" title="4.4.2 将证书文件夹所有者改为acme，使得用户acme有权限写入证书"></a>4.4.2 将证书文件夹所有者改为acme，使得用户acme有权限写入证书</h4>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo chown -R acme:acme /usr/<span class="built_in">local</span>/etc/certfiles</span><br></pre></td></tr></table></figure>

<h3 id="4-5-配置证书"><a href="#4-5-配置证书" class="headerlink" title="4.5 配置证书"></a>4.5 配置证书</h3><h4 id="4-5-1-安装acme-sh自动管理CA证书脚本"><a href="#4-5-1-安装acme-sh自动管理CA证书脚本" class="headerlink" title="4.5.1 安装acme.sh自动管理CA证书脚本"></a>4.5.1 安装acme.sh自动管理CA证书脚本</h4><p>  分别执行如下命令，不要复制 <code>#</code> 及之后的内容</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo su -l -s /bin/bash acme <span class="comment"># 切换到 acme 用户</span></span><br><span class="line"></span><br><span class="line">curl  https://get.acme.sh | sh <span class="comment"># 下载安装 acme.sh</span></span><br><span class="line"><span class="built_in">exit</span> <span class="comment"># 退出 acme 用户</span></span><br><span class="line"></span><br><span class="line">sudo su -l -s /bin/bash acme <span class="comment"># 再次切换到acme用户</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：这里两次切换用户的操作不能省略，因为安装完acme.sh之后要重新登录当前用户，否则无法识别出acme.sh命令</p>
</blockquote>
<h4 id="4-5-2-添加-cloudflare-Global-CA-Key"><a href="#4-5-2-添加-cloudflare-Global-CA-Key" class="headerlink" title="4.5.2 添加 cloudflare Global CA Key"></a>4.5.2 添加 cloudflare Global CA Key</h4><blockquote>
<p>不是使用cloudflare DNS的请查看域名申请与解析部分自己做调整！</p>
</blockquote>
<p>  登录 cloudflare，选择进入自己的站点，向下滚动页面，找到 <code>获取您的 API 令牌</code>，点击进入<br>  <a href="https://pic.downk.cc/item/5eeefceb14195aa59428f1b1.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeefceb14195aa59428f1b1.jpg" alt="进入API Key管理页面"></a><br>  可以看到，这里有两个<code>API 密钥</code>，一个是<code>Global API Key</code>，一个是<code>Origin CA Key</code>，我们要使用的是<code>Global API Key</code>，不要选错了，而且每天的查看次数有限，所以，查看之后记得复制保存一下，免得等下不能看了。另外，该API Key非常重要，请慎重保存，不要轻易泄露。<br>  <a href="https://pic.downk.cc/item/5eeefd3e14195aa594293530.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeefd3e14195aa594293530.jpg" alt="查看Global API Key"></a><br>  然后回到远程连接的云服务器，执行一下两条命令：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> CF_Key=<span class="string">"&lt;Your Global API Key&gt;"</span></span><br><span class="line"><span class="built_in">export</span> CF_Email=<span class="string">"&lt;Your cloudflare account Email&gt;"</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：将 <code>&quot;</code> 内的内容替换成你自己的，不要有 <code>&lt;&gt;</code>，我这里使用<code>&lt;&gt;</code>是表示这里的内容可替换，下面不再重复该提示</p>
</blockquote>
<h4 id="4-5-3-申请证书"><a href="#4-5-3-申请证书" class="headerlink" title="4.5.3 申请证书"></a>4.5.3 申请证书</h4><blockquote>
<p>不是使用cloudflare DNS的请查看域名申请与解析部分自己做调整！</p>
</blockquote>
<p>  执行如下命令（注意域名&lt;tdom.ml&gt;改为你自己的域名），等待一会儿。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">acme.sh --issue --dns dns_cf -d &lt;tdom.ml&gt;</span><br></pre></td></tr></table></figure>

<p>  看到下图的提示表示证书申请成功。<br>  <a href="https://pic.downk.cc/item/5eeeffe414195aa5942bb427.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eeeffe414195aa5942bb427.jpg" alt="证书申请成功"></a></p>
<blockquote>
<p>申请失败怎么办？证书申请失败的可能性一般有：1. CF_Key或CF_Email填写错误；证书申请次数超限等。此时切忌反复尝试，原因是证书每一个周申请次数是有限制的（20次），如果超限了就需要等一个周或者更换域名了（这个限制是争对每一个子域单独做的限制，所以万一超限了还可以用子域名继续部署）<br>解决方案是：在上述命令后加–staging参数继续测试。测试通过之后，删除上图所示四个证书文件并取消–staging参数再执行一次。–staging参数申请的证书只作为测试用，客户端是无法认证通过的（提示SSL handshake failed: tlsv1 alert unknown ca），所以使用–staging参数申请到了证书之后要去掉–staging参数重新申请一次。</p>
</blockquote>
<h4 id="4-5-4-安装证书"><a href="#4-5-4-安装证书" class="headerlink" title="4.5.4 安装证书"></a>4.5.4 安装证书</h4><p>  执行如下两条命令（注意域名<code>&lt;tdom.ml&gt;</code>改为你自己的域名）</p>
<p>  第一条：使用acme.sh将证书安装到certfiles目录，这样acme.sh更新证书的时候会自动将新的证书安装到这里。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">acme.sh --install-cert -d &lt;tdom.ml&gt; --key-file /usr/<span class="built_in">local</span>/etc/certfiles/private.key --fullchain-file /usr/<span class="built_in">local</span>/etc/certfiles/certificate.crt</span><br></pre></td></tr></table></figure>

<p>  第二条：配置acme.sh自动更新和自动更新证书，这样配置完Trojan之后一般不用管服务器。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">acme.sh  --upgrade  --auto-upgrade</span><br></pre></td></tr></table></figure>

<h4 id="4-5-5-修改权限"><a href="#4-5-5-修改权限" class="headerlink" title="4.5.5 修改权限"></a>4.5.5 修改权限</h4><p>  最后还要允许组内用户访问证书。可通过如下命令实现：</p>
<p>  将证书文件夹所在用户组改为certusers</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chown -R acme:certusers /usr/<span class="built_in">local</span>/etc/certfiles</span><br></pre></td></tr></table></figure>

<p>  赋予证书文件夹组内用户读取权限，运行这两条命令之后用户trojan就有权限读取证书了</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">chmod -R 750 /usr/<span class="built_in">local</span>/etc/certfiles</span><br></pre></td></tr></table></figure>

<p>  退出用户acme，因为证书已经安装完成</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure>

<h3 id="4-6-配置Trojan"><a href="#4-6-配置Trojan" class="headerlink" title="4.6 配置Trojan"></a>4.6 配置Trojan</h3><h4 id="4-6-1-安装Trojan"><a href="#4-6-1-安装Trojan" class="headerlink" title="4.6.1 安装Trojan"></a>4.6.1 安装Trojan</h4><p>  分别执行如下四个命令，注意看是否报错。</p>
<p>  安装Trojan，安装完成一般会提示版本号，注意看是否是最新版本</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/trojan-gfw/trojan-quickstart/master/trojan-quickstart.sh)</span>"</span></span><br></pre></td></tr></table></figure>

<p>  将Trojan配置文件的所有者修改为用户trojan，由于使用sudo安装的Trojan，该配置文件默认是属于root用户的，而我们需要使用用户trojan运行Trojan，不修改所有者会导致启动Trojan遇到权限问题</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo chown -R trojan:trojan /usr/<span class="built_in">local</span>/etc/trojan</span><br></pre></td></tr></table></figure>

<p>  备份Trojan配置文件，以防万一</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo cp /usr/<span class="built_in">local</span>/etc/trojan/config.json /usr/<span class="built_in">local</span>/etc/trojan/config.json.bak</span><br></pre></td></tr></table></figure>

<p>  使用nano修改配置文件</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /usr/<span class="built_in">local</span>/etc/trojan/config.json</span><br></pre></td></tr></table></figure>

<p>  第四个命令执行完之后屏幕会显示Trojan的配置文件，定位到<code>password</code>、<code>cert</code>和<code>key</code>并修改。密码按自己喜好（该密码等下客户端要用），<code>cert</code>和<code>key</code>分别改为<code>/usr/local/etc/certfiles/certificate.crt</code>和<code>/usr/local/etc/certfiles/private.key</code>。编辑完成配置文件之后按屏幕下方快捷键提示（<code>^O</code>和<code>^X</code>即：<code>Ctrl+O</code>和<code>Ctrl+X</code>）保存并退出nano。修改之后的config文件如图所示。另外，如果有<code>IPv6</code>地址，将<code>local_addr</code>的<code>0.0.0.0</code>改为<code>::</code>才可以使用。</p>
<h4 id="4-6-2-启动Trojan"><a href="#4-6-2-启动Trojan" class="headerlink" title="4.6.2 启动Trojan"></a>4.6.2 启动Trojan</h4><h5 id="4-6-2-1-修改Trojan启动用户"><a href="#4-6-2-1-修改Trojan启动用户" class="headerlink" title="4.6.2.1 修改Trojan启动用户"></a>4.6.2.1 修改Trojan启动用户</h5><p>  执行如下命令，打开trojan.service文件</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/systemd/system/trojan.service</span><br></pre></td></tr></table></figure>

<p>  在 <code>[Service]</code> 标签中的 <code>StandardError=journal</code> 一行下，添加 <code>User=trojan</code> ，结果如下：</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type&#x3D;simple</span><br><span class="line">StandardError&#x3D;journal</span><br><span class="line">User&#x3D;trojan</span><br><span class="line">ExecStart&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;bin&#x2F;trojan&quot; &quot;&#x2F;usr&#x2F;local&#x2F;etc&#x2F;trojan&#x2F;config.json&quot;</span><br><span class="line">ExecReload&#x3D;&#x2F;bin&#x2F;kill -HUP $MAINPID</span><br><span class="line">LimitNOFILE&#x3D;51200</span><br><span class="line">Restart&#x3D;on-failure</span><br><span class="line">RestartSec&#x3D;1s</span><br></pre></td></tr></table></figure>

<p>  然后重新加载配置文件</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl daemon-reload</span><br></pre></td></tr></table></figure>

<h5 id="4-6-2-2-配置Trojan监听443端口"><a href="#4-6-2-2-配置Trojan监听443端口" class="headerlink" title="4.6.2.2 配置Trojan监听443端口"></a>4.6.2.2 配置Trojan监听443端口</h5><p>  执行如下命令，赋予Trojan监听1024以下端口的能力，使得Trojan可以监听到443端口。这是由于我们使用非root用户启动Trojan，但是Linux默认不允许非root用户启动的进程监听1024以下的端口，除非为每一个二进制文件显式声明。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">setcap</span> CAP_NET_BIND_SERVICE=+eip /usr/<span class="built_in">local</span>/bin/trojan</span><br></pre></td></tr></table></figure>

<h5 id="4-6-2-3-使用systemd启动Trojan"><a href="#4-6-2-3-使用systemd启动Trojan" class="headerlink" title="4.6.2.3 使用systemd启动Trojan"></a>4.6.2.3 使用systemd启动Trojan</h5><p>  Trojan启动、查看状态命令分别如下：</p>
<p>  启动Trojan</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart trojan</span><br></pre></td></tr></table></figure>

<p>  查看Trojan运行状态</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl status trojan</span><br></pre></td></tr></table></figure>

<p>  Trojan运行成功如下图：<br>  <a href="https://pic.downk.cc/item/5eef07ac14195aa594339444.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eef07ac14195aa594339444.jpg" alt="trojan运行成功"></a></p>
<h5 id="4-6-2-4-更新证书"><a href="#4-6-2-4-更新证书" class="headerlink" title="4.6.2.4 更新证书"></a>4.6.2.4 更新证书</h5><p>  当acme.sh重新安装证书之后，需要通知Trojan重新加载证书。最简单的方案是每三个月登录服务器重启Trojan，但是不够完美，毕竟重启的时候会导致服务中断。其实Trojan有实现 <a href="https://github.com/trojan-gfw/trojan/commit/53ca5f80fcd6239c28c8520886692e9186e3fcf6" target="_blank" rel="noopener">reload certificate and private key</a> 功能，只需要在证书更新后给Trojan发送SIGUSR1消息即可。Trojan收到SIGUSR1消息后便会自动加载新的证书和密钥文件，这样就不用重启Trojan了。手动给Trojan发送SIGUSR1消息的命令是s<code>udo -u trojan killall -s SIGUSR1 trojan</code>，但是这样也不够完美，也得每三个月登录服务器运行一次该命令。其实我们可以给用户trojan添加定时任务，使其每个月运行一次该命令即可。实现如下：</p>
<p>  首先，编辑用户trojan的crontab文件</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo -u trojan crontab -e</span><br></pre></td></tr></table></figure>

<p>  在文件末尾添加一行如下，该行表示每个月1号的时候运行命令<code>killall -s SIGUSR1 trojan</code>，由于是使用用户trojan运行的，故不需要在前面加<code>sudo -u trojan</code>。</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">0 0 1 * * killall -s SIGUSR1 trojan</span><br></pre></td></tr></table></figure>

<p>  最后查看crontab是否生效。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo -u trojan crontab -l</span><br></pre></td></tr></table></figure>

<h5 id="4-6-2-5-更新Trojan"><a href="#4-6-2-5-更新Trojan" class="headerlink" title="4.6.2.5 更新Trojan"></a>4.6.2.5 更新Trojan</h5><p>  如果Trojan版本有<a href="https://github.com/trojan-gfw/trojan/releases" target="_blank" rel="noopener">更新</a>，那么使用本教程搭建的服务器端更新Trojan版本只需要三条命令即可。</p>
<p>  更新Trojan</p>
<blockquote>
<p>注意：会提示是否覆盖配置文件，如果没有必要请回答n，否则配置文件将会被覆盖（如果不小心覆盖了就得自己重新编辑了）</p>
</blockquote>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo bash -c <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/trojan-gfw/trojan-quickstart/master/trojan-quickstart.sh)</span>"</span></span><br></pre></td></tr></table></figure>

<p>  重新赋予Trojan监听443端口的能力</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo <span class="built_in">setcap</span> CAP_NET_BIND_SERVICE=+eip /usr/<span class="built_in">local</span>/bin/trojan</span><br></pre></td></tr></table></figure>

<p>  重启Trojan</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart trojan</span><br></pre></td></tr></table></figure>

<h3 id="4-7-配置Nginx"><a href="#4-7-配置Nginx" class="headerlink" title="4.7 配置Nginx"></a>4.7 配置Nginx</h3><h4 id="4-7-1-写入虚拟主机到Nginx配置文件"><a href="#4-7-1-写入虚拟主机到Nginx配置文件" class="headerlink" title="4.7.1 写入虚拟主机到Nginx配置文件"></a>4.7.1 写入虚拟主机到Nginx配置文件</h4><p>  由于Nginx配置在Debian系列系统和CentOS系列系统组织方式不同，所以配置文件位置和使用方式有细微区别，为了统一，我将CentOS系列系统的组织结构做细微调整。</p>
<p>  在Debian系列系统中，Nginx的虚拟主机配置文件在<code>/etc/nginx/sites-available/</code>文件夹中，如果要开启某一个虚拟主机，则建立一个软连接到<code>/etc/nginx/sites-enabled/</code>文件夹并重启Nginx即可。默认虚拟主机在<code>/etc/nginx/sites-enabled/</code>文件夹，需要关闭掉，否则会冲突。</p>
<p>  在CentOS系列系统中，Nginx的虚拟主机配置文件在<code>/etc/nginx/conf.d/</code>文件夹中以.conf后缀保存，写入之后就可以使用。默认虚拟主机集成在Nginx配置文件<code>/etc/nginx/nginx.conf</code>中，需要打开将其中的server块删除，否则会冲突。Debian系列系统中的<code>/etc/nginx/sites-enabled/</code>和<code>/etc/nginx/sites-available/</code>文件夹结构在CentOS系列系统中是没有的，不过这个策略很不错，可以很方便的开启和关闭虚拟主机，我这里手动调整一下。</p>
<h5 id="4-7-1-1-CentOS"><a href="#4-7-1-1-CentOS" class="headerlink" title="4.7.1.1 CentOS"></a>4.7.1.1 CentOS</h5><p>  按上述分析，我们使用下面两条命令在<code>/etc/nginx/</code>中添加两个文件夹。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mkdir /etc/nginx/sites-available</span><br><span class="line">sudo mkdir /etc/nginx/sites-enabled</span><br></pre></td></tr></table></figure>

<p>  执行如下命令使用nano打开Nginx配置文件，删除其中server块，并添加对<code>/etc/nginx/sites-enabled/</code>文件夹的索引。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/nginx/nginx.conf</span><br></pre></td></tr></table></figure>

<p>  在<code>include /etc/nginx/conf.d/*.conf;</code>下添加一行：</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">include &#x2F;etc&#x2F;nginx&#x2F;sites-enabled&#x2F;*;</span><br></pre></td></tr></table></figure>

<p>  CentOS反向代理需要配置SELinux允许httpd模块可以联网，否则服务器会返回502错误。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo setsebool -P httpd_can_network_connect <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h5 id="4-7-1-2-Ubuntu-or-Debian"><a href="#4-7-1-2-Ubuntu-or-Debian" class="headerlink" title="4.7.1.2 Ubuntu or Debian"></a>4.7.1.2 Ubuntu or Debian</h5><p>  使用如下命令关闭Nginx默认虚拟主机。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo rm /etc/nginx/sites-enabled/default</span><br></pre></td></tr></table></figure>

<h5 id="4-7-1-3-写入配置"><a href="#4-7-1-3-写入配置" class="headerlink" title="4.7.1.3 写入配置"></a>4.7.1.3 写入配置</h5><p>  执行如下命令，使用nano添加虚拟主机。(注意域名&lt;tdom.ml&gt;改为你自己的域名，这是虚拟主机的文件名，只是用来自己识别的。如果你已经有配置虚拟主机在这个文件中，可以自己使用cp命令备份一下或者换个名字也行，等介绍完基本配置再讲如何与现有服务集成。)</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/nginx/sites-available/&lt;tdom.ml&gt;</span><br></pre></td></tr></table></figure>

<p>  基于综述部分讲解的Trojan工作原理，现给定Nginx虚拟主机如下所示。这些虚拟主机可以直接拷贝到上面虚拟主机配置文件中再修改为你自己的，其中要修改的地方包括：</p>
<ul>
<li><p>第4行的<code>server_name</code>的值<code>&lt;tdom.ml&gt;</code>改为你自己的域名；</p>
</li>
<li><p>第7行的<code>proxy_pass</code>随便指向一个没有敏感信息的网站都可以，这就是你要反向代理的网站，这里我是用了RFC文档的地址；</p>
</li>
<li><p>第15行的<code>server_name</code>的值<code>&lt;10.10.10.10&gt;</code>改为你自己的IP；</p>
</li>
<li><p>第17行<code>&lt;tdom.ml&gt;</code>改为自己的域名，注意别填错了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 127.0.0.1:80 default_server;</span><br><span class="line"></span><br><span class="line">    server_name &lt;tdom.ml&gt;;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass https://www.ietf.org;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 127.0.0.1:80;</span><br><span class="line"></span><br><span class="line">    server_name &lt;10.10.10.10&gt;;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 301 https://&lt;tdom.ml&gt;<span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen 0.0.0.0:80;</span><br><span class="line">    listen [::]:80;</span><br><span class="line"></span><br><span class="line">    server_name _;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">return</span> 301 https://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>解释一下这些虚拟主机的一些细节：第一个server接收来自Trojan的流量，与上面Trojan配置文件对应；第二个server也是接收来自Trojan的流量，但是这个流量尝试使用IP而不是域名访问服务器，所以将其认为是异常流量，并重定向到域名；第三个server接收除127.0.0.1:80外的所有80端口的流量并重定向到443端口，这样便开启了全站https，可有效的防止恶意探测。注意到，第一个和第二个server对应综述部分原理图中的蓝色数据流，第三个server对应综述部分原理图中的红色数据流，综述部分原理图中的绿色数据流不会流到Nginx。</p>
<p>将建好的虚拟机连接到Nginx，注意域名&lt;tdom.ml&gt;改为你自己的域名</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ln -s /etc/nginx/sites-available/&lt;tdom.ml&gt; /etc/nginx/sites-enabled/</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="4-7-2-启动Nginx"><a href="#4-7-2-启动Nginx" class="headerlink" title="4.7.2 启动Nginx"></a>4.7.2 启动Nginx</h4><p>  Nginx启动命令和Trojan一样，就不过多解释了。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl restart nginx</span><br><span class="line">sudo systemctl status nginx</span><br></pre></td></tr></table></figure>

<h4 id="4-7-3-与现有Nginx服务集成"><a href="#4-7-3-与现有Nginx服务集成" class="headerlink" title="4.7.3 与现有Nginx服务集成"></a>4.7.3 与现有Nginx服务集成</h4><p>  如果你本机已经有Nginx服务，那么Nginx配置文件需要做适当修改以和现有服务兼容。</p>
<p>  在原服务与Trojan使用同一个域名且原来是监听443端口的情况下，那么需要将你的ssl配置删除并将监听地址改为第一个server监听的地址127.0.0.1:80，然后直接用修改好的server代替上述配置文件中第一个server即可。这样https加密部分将会由Trojan处理之后转发给Nginx而不是由Nginx处理，原来的服务对于客户端来说就没有变化。</p>
<p>  如果原来的服务与Trojan使用不同的域名，建议是修改Trojan与原来的服务使用同一个域名，如果非要使用不同的域名，请参考第3点。</p>
<p>  如果原来的服务就监听了多个域名，那么请自己琢磨Nginx的sni，参考连接：<a href="http://nginx.org/en/docs/stream/ngx_stream_ssl_preread_module.html" target="_blank" rel="noopener">ngx_stream_ssl_preread_module</a>。</p>
<p>  如果原来的服务是监听80端口，想要继续监听80端口那么直接去除第三个server即可，如果要改为监听443端口参考第1点。</p>
<h3 id="4-8-配置Trojan和Nginx开机自启"><a href="#4-8-配置Trojan和Nginx开机自启" class="headerlink" title="4.8 配置Trojan和Nginx开机自启"></a>4.8 配置Trojan和Nginx开机自启</h3><p>  虽然开机自启一般用不着，除非vultr机房停电，但是反正也没什么代价，弄一下吧。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">enable</span> trojan</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> nginx</span><br></pre></td></tr></table></figure>

<h3 id="4-9-检查服务器是否配置成功"><a href="#4-9-检查服务器是否配置成功" class="headerlink" title="4.9 检查服务器是否配置成功"></a>4.9 检查服务器是否配置成功</h3><p>  到这里服务器就配置完成了。此时你可以在浏览器里面访问你的网站看是否能够访问，如果你的网站可以访问了，那么就一切正常啦。</p>
<ul>
<li>浏览器中使用ip访问：重定向到<a href="https://tdom.ml" target="_blank" rel="noopener">https://tdom.ml</a>;</li>
<li>浏览器中使用<a href="https://ip访问：重定向到https://tdom.ml(跳转的时候浏览器可能提示不安全是正常的)">https://ip访问：重定向到https://tdom.ml(跳转的时候浏览器可能提示不安全是正常的)</a>;</li>
<li>浏览器中使用tdom.ml访问：重定向到<a href="https://tdom.ml" target="_blank" rel="noopener">https://tdom.ml</a></li>
</ul>
<h3 id="4-10-启动bbr（可选，建议）"><a href="#4-10-启动bbr（可选，建议）" class="headerlink" title="4.10 启动bbr（可选，建议）"></a>4.10 启动bbr（可选，建议）</h3><p>  启动bbr需要Linux内核版本在4.10及以上，如果低于该版本需要自己升级（这不在本教程范围之后）内核版本，保证内核版本不低于4.10。查看系统内核版本命令如下。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">uname -a</span><br></pre></td></tr></table></figure>

<p>  bbr是谷歌开发的网络控制算法，可以加快访问速度。执行下面命令查看当前系统是否启用bbr。</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo sysctl net.ipv4.tcp_congestion_control</span><br></pre></td></tr></table></figure>

<p>  执行完成之后如果提示<code>net.ipv4.tcp_congestion_control = bbr</code>即表示启动了bbr，可以跳过下面启动bbr的步骤。</p>
<p>  执行以下三条命令，启动bbr</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo bash -c <span class="string">'echo "net.core.default_qdisc=fq" &gt;&gt; /etc/sysctl.conf'</span></span><br><span class="line">sudo bash -c <span class="string">'echo "net.ipv4.tcp_congestion_control=bbr" &gt;&gt; /etc/sysctl.conf'</span></span><br><span class="line">sudo sysctl -p</span><br></pre></td></tr></table></figure>

<h3 id="4-11-配置防火墙"><a href="#4-11-配置防火墙" class="headerlink" title="4.11 配置防火墙"></a>4.11 配置防火墙</h3><p>  只打开22、80和443端口可以有效的阻止外部恶意流量，降低服务器暴露的风险。此步骤非必须，而且自己有其他服务记得其他服务的端口也要处理。</p>
<p>  本文以ufw为例配置防火墙，ufw是一个很好用的防火墙配置命令，可以简化操作，减少错误的发生。</p>
<h4 id="4-11-1-安装ufw"><a href="#4-11-1-安装ufw" class="headerlink" title="4.11.1 安装ufw"></a>4.11.1 安装ufw</h4><h5 id="4-11-1-1-Debian-or-Ubuntu"><a href="#4-11-1-1-Debian-or-Ubuntu" class="headerlink" title="4.11.1.1 Debian or Ubuntu"></a>4.11.1.1 Debian or Ubuntu</h5><p>  执行如下命令安装ufw：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt install -y ufw</span><br></pre></td></tr></table></figure>

<h5 id="4-11-1-2-CentOS"><a href="#4-11-1-2-CentOS" class="headerlink" title="4.11.1.2 CentOS"></a>4.11.1.2 CentOS</h5><p>  执行如下两个命令安装ufw：</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo yum install -y epel-release</span><br><span class="line">sudo yum install -y ufw</span><br></pre></td></tr></table></figure>

<h4 id="4-11-2-如果服务器无IPv6地址"><a href="#4-11-2-如果服务器无IPv6地址" class="headerlink" title="4.11.2 如果服务器无IPv6地址"></a>4.11.2 如果服务器无IPv6地址</h4><p>  需要执行如下命令，将IPV6=yes修改为IPV6=no</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo nano /etc/default/ufw</span><br></pre></td></tr></table></figure>

<h4 id="4-11-3-配置防火墙"><a href="#4-11-3-配置防火墙" class="headerlink" title="4.11.3 配置防火墙"></a>4.11.3 配置防火墙</h4>  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ufw <span class="built_in">disable</span></span><br><span class="line">sudo ufw allow ssh</span><br><span class="line">sudo ufw allow https</span><br><span class="line">sudo ufw allow http</span><br><span class="line">sudo ufw <span class="built_in">enable</span></span><br></pre></td></tr></table></figure>

  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo ufw status</span><br><span class="line">sudo ufw status verbose</span><br></pre></td></tr></table></figure>

<blockquote>
<p>另外，如果对Trojan不放心，那么可以参考trojan wiki，优化防火墙配置，使得Trojan只能给127.0.0.1:80发送数据和响应外部请求。</p>
</blockquote>
<h2 id="5-配置trojan客户端"><a href="#5-配置trojan客户端" class="headerlink" title="5. 配置trojan客户端"></a>5. 配置trojan客户端</h2><p>  <a href="https://github.com/Trojan-Qt5/Trojan-Qt5/releases/tag/v1.2.0" target="_blank" rel="noopener">Trojan-Qt5</a>是一个专为trojan开发的跨平台的GUI客户端，目前支持Windows、Linux、Mac。<br>  <a href="https://pic.downk.cc/item/5eef299714195aa5945362bb.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eef299714195aa5945362bb.jpg" alt="Trojan-Qt5主窗口"></a><br>  点击<code>连接-&gt;添加-&gt;手动-&gt;Trojan</code>添加服务器，<br>  <a href="https://pic.downk.cc/item/5eef2b6a14195aa59455b90f.jpg" target="_blank" rel="noopener"><img src="https://pic.downk.cc/item/5eef2b6a14195aa59455b90f.jpg" alt="添加服务器"></a><br>  其他配置项不懂的话不要动，就按照默认的即可。<br>  小图标右键菜单，还可以设置代理模式和PAC模式，可以根据需要进行调整。</p>
<h2 id="6-SwitchyOmega配置"><a href="#6-SwitchyOmega配置" class="headerlink" title="6. SwitchyOmega配置"></a>6. SwitchyOmega配置</h2><p>  SwitchyOmega是Chrome上的一款插件，网上有教程，用法此处不再赘述，可以配合使用已达到更好的效果。</p>
<h2 id="7-FQA"><a href="#7-FQA" class="headerlink" title="7. FQA"></a>7. FQA</h2><h3 id="7-1-ERR-SSL-PROTOCOL-ERROR"><a href="#7-1-ERR-SSL-PROTOCOL-ERROR" class="headerlink" title="7.1 ERR_SSL_PROTOCOL_ERROR"></a>7.1 ERR_SSL_PROTOCOL_ERROR</h3><blockquote>
<p>在配置完服务器和客户端之后，访问Google，发现提示无法提供安全访问链接，并且有<code>ERR_SSL_PROTOCOL_ERROR</code>的错误提示</p>
</blockquote>
<p>  查了很久，发现是Cloudflare的CDN打开了，这个不能开的，如果打开了就会出现这个情况。另外，可以ba把Cloudflare中的SSL设置为严格模式。</p>
]]></content>
      <categories>
        <category>科学上网</category>
        <category>Trojan</category>
      </categories>
      <tags>
        <tag>Trojan</tag>
        <tag>科学上网</tag>
      </tags>
  </entry>
</search>
